name: Create Scheduled Release Branch 🗓️

on:
  schedule:
    - cron: '30 16 * * 5'  # Every Friday 10 PM IST = 4:30 PM UTC
  workflow_dispatch:

permissions:
  contents: write

jobs:
  create-incremental-release-branch:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set date prefix (YYMM)
        id: version
        run: |
          echo "prefix=$(date -u '+%y%m')" >> "$GITHUB_OUTPUT"

      - name: Fetch all remote branches
        run: git fetch --all --quiet --prune

      - name: Determine next branch version
        id: next
        run: |
          PREFIX=${{ steps.version.outputs.prefix }}
          EXISTING=$(git ls-remote --heads origin "refs/heads/releases/release_${PREFIX}.*" \
            | awk -F'releases/release_' '{print $2}' \
            | awk -F'/' '{print $1}')
          if [ -z "$EXISTING" ]; then
            NEXT=1
          else
            MAX=$(echo "$EXISTING" | sed -E 's/^([0-9]{4})\.([0-9]+)$/\2/' | sort -nr | head -n1)
            NEXT=$((MAX + 1))
          fi
          BRANCH_NAME="releases/release_${PREFIX}.${NEXT}"
          echo "branch=$BRANCH_NAME" >> "$GITHUB_OUTPUT"

      - name: Create and push release branch
        env:
          BRANCH_NAME: ${{ steps.next.outputs.branch }}
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git checkout -b "$BRANCH_NAME"
          git push origin "$BRANCH_NAME"
