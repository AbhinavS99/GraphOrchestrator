- name: Checkout repository
  uses: actions/checkout@v4

- name: Set up Python
  uses: actions/setup-python@v5
  with:
    python-version: '3.12'

- name: Install dependencies
  run: |
    python -m pip install --upgrade pip
    pip install -r requirements.txt
    pip install black coverage codecov pytest pytest-asyncio pre-commit mypy

- name: Auto-format and commit with Black
  run: |
    black graphorchestrator tests

    git config --global user.name "github-actions[bot]"
    git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"

    if [[ -n "$(git status --porcelain)" ]]; then
      echo "ðŸ”µ Detected formatting changes. Committing..."
      git add .
      git commit -m "ðŸ¤– Auto-format code with Black"
      git push https://${{ secrets.PAT_TOKEN }}@github.com/${{ github.repository }} HEAD:${{ github.head_ref }}
    else
      echo "âœ… No formatting changes detected. No commit necessary."
    fi

- name: Run static type checks (mypy)
  run: |
    mypy graphorchestrator tests

- name: Run tests with coverage
  run: |
    coverage run -m pytest
    coverage report --fail-under=85
    coverage xml

- name: Upload coverage to Codecov
  uses: codecov/codecov-action@v4
  with:
    token: ${{ secrets.CODECOV_TOKEN }}
    files: coverage.xml
    flags: pytest
    name: python-coverage
    fail_ci_if_error: true
